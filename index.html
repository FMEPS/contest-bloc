<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gestion de contest de bloc d'escalade pour l'EPS">
    <meta name="theme-color" content="#0891b2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Contest Bloc">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230891b2' width='180' height='180'/><text x='90' y='110' font-size='80' text-anchor='middle' fill='white' font-family='Arial'>üßó</text></svg>">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 152 152'><rect fill='%230891b2' width='152' height='152'/><text x='76' y='95' font-size='70' text-anchor='middle' fill='white' font-family='Arial'>üßó</text></svg>">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><rect fill='%230891b2' width='120' height='120'/><text x='60' y='75' font-size='55' text-anchor='middle' fill='white' font-family='Arial'>üßó</text></svg>">
    <link rel="icon" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%230891b2' width='192' height='192'/><text x='96' y='120' font-size='90' text-anchor='middle' fill='white' font-family='Arial'>üßó</text></svg>">
    <title>Contest Bloc d'Escalade - EPS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #4f46e5;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        h2 {
            color: #1e293b;
            margin: 20px 0 15px;
            font-size: 1.5rem;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"] {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-secondary {
            background: #6366f1;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-gray {
            background: #6b7280;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .item button {
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .warning {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #92400e;
        }

        .info {
            background: #dbeafe;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            color: #1e40af;
        }

        .center-btn {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .center-btn button {
            font-size: 1.2rem;
            padding: 15px 40px;
        }

        /* Timer */
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 50%;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 5px solid #0891b2;
            z-index: 1000;
            width: 150px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .timer-container.warning {
            border-color: #f59e0b;
        }

        .timer-container.danger {
            border-color: #ef4444;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
        }

        .timer-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .timer-controls button {
            padding: 5px 10px;
            font-size: 1rem;
        }

        .timer-message {
            font-size: 0.8rem;
            color: #ef4444;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
        }

        .end-contest-btn {
            position: fixed;
            top: 190px;
            right: 20px;
            z-index: 1000;
        }

        /* Contest screen */
        .contest-content {
            margin-top: 180px;
        }

        .top-left-actions {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .top-left-actions button {
            padding: 12px 20px;
            font-size: 1rem;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .student-btn {
            padding: 12px 8px;
            font-size: 0.95rem;
            background: #4f46e5;
            color: white;
        }

        .fixed-actions {
            position: fixed;
            bottom: 20px;
            width: calc(100% - 40px);
            max-width: 1160px;
            display: flex;
            justify-content: space-between;
        }

        /* Validation screen */
        .validation-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .back-btn {
            background: #6b7280;
            color: white;
            padding: 10px 15px;
            font-size: 1.2rem;
        }

        .blocks-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .block-card {
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #e2e8f0;
        }

        .block-card.validated {
            background: #d1fae5;
            border-color: #10b981;
        }

        .block-card:not(.validated) {
            background: #f1f5f9;
        }

        .block-card:hover {
            transform: scale(1.05);
        }

        .block-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .block-info {
            font-size: 0.9rem;
            color: #64748b;
        }

        .block-points {
            font-size: 1rem;
            color: #4f46e5;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Ranking */
        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
        }

        .podium-place {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            min-width: 150px;
        }

        .podium-place.gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            order: 2;
            padding-top: 40px;
        }

        .podium-place.silver {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
            order: 1;
            padding-top: 30px;
        }

        .podium-place.bronze {
            background: linear-gradient(135deg, #fdba74 0%, #f97316 100%);
            order: 3;
            padding-top: 20px;
        }

        .medal {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .podium-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .podium-score {
            font-size: 1rem;
            color: white;
        }

        .ranking-list {
            margin-top: 30px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .ranking-position {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4f46e5;
            min-width: 50px;
        }

        .ranking-name {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ranking-stats {
            text-align: right;
        }

        .ranking-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #10b981;
        }

        .ranking-blocks {
            font-size: 0.9rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .students-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .blocks-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .podium {
                flex-direction: column;
                align-items: center;
            }

            .podium-place {
                width: 100%;
            }

            .podium-place.gold,
            .podium-place.silver,
            .podium-place.bronze {
                order: 0;
                padding-top: 20px;
            }

            .fixed-actions {
                flex-direction: column;
                gap: 10px;
            }

            .timer-container {
                width: 100px;
                height: 100px;
                top: 10px;
                right: 10px;
            }

            .timer-display {
                font-size: 1.2rem;
            }

            .end-contest-btn {
                top: 125px;
                right: 10px;
                font-size: 0.85rem;
                padding: 8px 12px;
            }

            .top-left-actions {
                top: 10px;
                left: 10px;
                flex-direction: column;
                gap: 5px;
            }

            .top-left-actions button {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .contest-content {
                margin-top: 140px;
            }

            .center-btn {
                flex-direction: column;
                gap: 10px;
            }

            .center-btn button {
                width: 100%;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .students-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 480px) {
            .students-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .blocks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßó Contest Bloc d'Escalade</h1>

        <!-- √âCRAN 1 : CONFIGURATION -->
        <div id="configScreen" class="screen active">
            <div class="section">
                <h2>Param√®tres g√©n√©raux</h2>
                <div class="input-group">
                    <label>Dur√©e du contest (minutes) :</label>
                    <input type="number" id="contestDuration" min="1" value="30">
                </div>
                <div class="input-group">
                    <input type="file" id="importFile" accept=".xls,.xlsx">
                    <button class="btn-secondary" onclick="importFromExcel()">Importer depuis Excel</button>
                </div>
                <div class="info">
                    <strong>√âl√®ves configur√©s :</strong> <span id="studentsCount">0</span><br>
                    <strong>Blocs configur√©s :</strong> <span id="blocksCount">0</span>
                </div>
                <button class="btn-danger" onclick="resetAll()">Tout r√©initialiser</button>
            </div>

            <div class="section">
                <h2>√âl√®ves (<span id="studentsCountTitle">0</span>)</h2>
                <div class="input-group">
                    <input type="text" id="studentName" placeholder="Nom de l'√©l√®ve">
                    <button class="btn-primary" onclick="addStudent()">Ajouter</button>
                </div>
                <div id="studentsList" class="grid"></div>
            </div>

            <div class="section">
                <h2>Blocs d'escalade (<span id="blocksCountTitle">0</span>)</h2>
                <div class="input-group">
                    <input type="text" id="blockName" placeholder="Nom du bloc">
                    <button class="btn-secondary" onclick="addBlock()">Ajouter</button>
                </div>
                <div id="blocksList" class="grid"></div>
            </div>

            <div id="warningMessage" class="warning" style="display: none;">
                ‚ö†Ô∏è Vous devez ajouter au moins 1 √©l√®ve et 1 bloc pour d√©marrer le contest.
            </div>

            <div class="center-btn">
                <button id="startBtn" class="btn-gray" onclick="startContest()" disabled>D√©marrer le contest</button>
            </div>
        </div>

        <!-- √âCRAN 2 : CONTEST EN COURS -->
        <div id="contestScreen" class="screen">
            <div class="top-left-actions">
                <button class="btn-success" onclick="showRanking()">Voir le classement</button>
                <button class="btn-primary" onclick="showBlockPoints()">Points par bloc</button>
            </div>
            <button class="btn-danger end-contest-btn" onclick="endContest()" style="display: none;" id="endContestBtn">Terminer le contest</button>
            <div class="contest-content">
                <h2>S√©lectionnez un √©l√®ve</h2>
                <div id="studentsButtons" class="students-grid"></div>
            </div>
        </div>

        <!-- √âCRAN 2B : VALIDATION √âL√àVE -->
        <div id="validationScreen" class="screen">
            <div class="validation-header">
                <button class="back-btn" onclick="backToContest()">‚Äπ</button>
                <div>
                    <h2 id="validationStudentName"></h2>
                    <div class="info">
                        Score actuel : <strong id="validationScore">0</strong> pts | 
                        Blocs valid√©s : <strong id="validationBlocksCount">0</strong>
                    </div>
                </div>
            </div>
            <div id="blocksValidation" class="blocks-grid"></div>
        </div>

        <!-- √âCRAN 2C : POINTS PAR BLOC -->
        <div id="blockPointsScreen" class="screen">
            <div class="top-left-actions">
                <button class="btn-primary" onclick="backToContestFromBlockPoints()">‚Äπ Retour</button>
            </div>
            <div class="contest-content">
                <h2>Points par bloc</h2>
                <div id="blockPointsList" class="blocks-grid"></div>
            </div>
        </div>

        <!-- √âCRAN 3 : CLASSEMENT -->
        <div id="rankingScreen" class="screen">
            <div class="top-left-actions">
                <button class="btn-primary" onclick="backToContestFromRanking()">‚Äπ Retour au contest</button>
            </div>
            <div style="margin-top: 80px;">
                <h2>Classement</h2>
                
                <div id="podium" class="podium"></div>
                
                <div id="rankingList" class="ranking-list"></div>
                
                <div class="center-btn">
                    <button class="btn-success" onclick="exportToExcel()">üìä Exporter en Excel</button>
                    <button class="btn-danger" onclick="exportToPDF()">üìÑ Exporter en PDF</button>
                    <button class="btn-gray" onclick="finishContest()">Terminer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer (visible uniquement pendant le contest) -->
    <div id="timerContainer" class="timer-container" style="display: none;">
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div class="timer-controls">
            <button class="btn-warning" onclick="toggleTimer()">
                <span id="timerToggleIcon">‚è∏</span>
            </button>
            <button class="btn-danger" onclick="resetTimer()">‚Üª</button>
        </div>
        <div id="timerMessage" class="timer-message"></div>
    </div>

    <script>
        // √âtat de l'application
        let state = {
            students: [],
            blocks: [],
            validations: {},
            duration: 30,
            timerSeconds: 0,
            timerRunning: false,
            timerInterval: null,
            currentStudentId: null,
            nextStudentId: 1,
            nextBlockId: 1
        };

        // Chargement initial
        window.addEventListener('load', () => {
            loadState();
            updateUI();
            registerServiceWorker();
            generateManifest();
        });

        // PWA - Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'contest-bloc-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            }
        }

        // PWA - Manifeste
        function generateManifest() {
            const manifest = {
                name: "Contest Bloc d'Escalade",
                short_name: "Contest Bloc",
                description: "Gestion de contest de bloc d'escalade pour l'EPS",
                start_url: "./",
                display: "standalone",
                background_color: "#e0f2fe",
                theme_color: "#0891b2",
                icons: [
                    {
                        src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%230891b2' width='192' height='192'/><text x='96' y='120' font-size='90' text-anchor='middle' fill='white' font-family='Arial'>üßó</text></svg>",
                        sizes: "192x192",
                        type: "image/svg+xml"
                    }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestUrl;
            document.head.appendChild(link);
        }

        // Sauvegarde et chargement
        function saveState() {
            localStorage.setItem('contestBlocState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('contestBlocState');
            if (saved) {
                const loaded = JSON.parse(saved);
                state = { ...state, ...loaded };
                state.timerRunning = false;
                state.timerInterval = null;
            }
        }

        // Gestion des √©l√®ves
        function addStudent() {
            const input = document.getElementById('studentName');
            const name = input.value.trim();
            if (name) {
                state.students.push({ id: state.nextStudentId++, name });
                state.validations[state.students[state.students.length - 1].id] = [];
                input.value = '';
                saveState();
                updateUI();
            }
        }

        function removeStudent(id) {
            state.students = state.students.filter(s => s.id !== id);
            delete state.validations[id];
            saveState();
            updateUI();
        }

        function importFromExcel() {
            const input = document.getElementById('importFile');
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Lecture de la premi√®re feuille
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Ensemble pour √©viter les doublons
                    const studentNames = new Set();
                    const blockNames = new Set();
                    
                    // Parcourir toutes les lignes
                    jsonData.forEach(row => {
                        // Colonne A (index 0) : Pr√©noms des √©l√®ves
                        if (row[0] && String(row[0]).trim()) {
                            studentNames.add(String(row[0]).trim());
                        }
                        
                        // Colonne B (index 1) : Noms des blocs
                        if (row[1] && String(row[1]).trim()) {
                            blockNames.add(String(row[1]).trim());
                        }
                    });
                    
                    // Ajouter les √©l√®ves
                    studentNames.forEach(name => {
                        // V√©rifier si l'√©l√®ve n'existe pas d√©j√†
                        if (!state.students.find(s => s.name === name)) {
                            const studentId = state.nextStudentId++;
                            state.students.push({ id: studentId, name });
                            state.validations[studentId] = [];
                        }
                    });
                    
                    // Ajouter les blocs
                    blockNames.forEach(name => {
                        // V√©rifier si le bloc n'existe pas d√©j√†
                        if (!state.blocks.find(b => b.name === name)) {
                            state.blocks.push({ id: state.nextBlockId++, name });
                        }
                    });
                    
                    saveState();
                    updateUI();
                    
                    alert(`Importation r√©ussie !\n${studentNames.size} √©l√®ve(s) et ${blockNames.size} bloc(s) ajout√©(s).`);
                    input.value = ''; // R√©initialiser l'input file
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // Gestion des blocs
        function addBlock() {
            const input = document.getElementById('blockName');
            const name = input.value.trim();
            if (name) {
                state.blocks.push({ id: state.nextBlockId++, name });
                input.value = '';
                saveState();
                updateUI();
            }
        }

        function removeBlock(id) {
            state.blocks = state.blocks.filter(b => b.id !== id);
            // Retirer ce bloc de toutes les validations
            Object.keys(state.validations).forEach(studentId => {
                state.validations[studentId] = state.validations[studentId].filter(bId => bId !== id);
            });
            saveState();
            updateUI();
        }

        // Calcul des points
        function calculateBlockPoints(blockId) {
            const validationCount = Object.values(state.validations)
                .filter(blocks => blocks.includes(blockId)).length;
            
            const totalStudents = state.students.length;
            if (totalStudents === 0) return 100;
            
            const percentage = (validationCount / totalStudents) * 100;
            const points = Math.round(100 - percentage);
            
            // Si 100% des √©l√®ves ont valid√©, le bloc vaut 5 points
            if (percentage === 100) return 5;
            
            return Math.max(5, points);
        }

        function calculateStudentScore(studentId) {
            const validatedBlocks = state.validations[studentId] || [];
            return validatedBlocks.reduce((sum, blockId) => {
                return sum + calculateBlockPoints(blockId);
            }, 0);
        }

        // UI Updates
        function updateUI() {
            // Mise √† jour des compteurs
            document.getElementById('studentsCount').textContent = state.students.length;
            document.getElementById('blocksCount').textContent = state.blocks.length;
            document.getElementById('studentsCountTitle').textContent = state.students.length;
            document.getElementById('blocksCountTitle').textContent = state.blocks.length;

            // Liste des √©l√®ves
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = state.students.map(s => `
                <div class="item">
                    <span>${s.name}</span>
                    <button onclick="removeStudent(${s.id})">‚úï</button>
                </div>
            `).join('');

            // Liste des blocs
            const blocksList = document.getElementById('blocksList');
            blocksList.innerHTML = state.blocks.map(b => `
                <div class="item">
                    <span>${b.name}</span>
                    <button onclick="removeBlock(${b.id})">‚úï</button>
                </div>
            `).join('');

            // Bouton de d√©marrage
            const startBtn = document.getElementById('startBtn');
            const warningMsg = document.getElementById('warningMessage');
            
            if (state.students.length > 0 && state.blocks.length > 0) {
                startBtn.disabled = false;
                startBtn.className = 'btn-success';
                warningMsg.style.display = 'none';
            } else {
                startBtn.disabled = true;
                startBtn.className = 'btn-gray';
                warningMsg.style.display = 'block';
            }

            // Dur√©e du contest
            state.duration = parseInt(document.getElementById('contestDuration').value) || 30;
        }

        // Gestion des √©crans
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // D√©marrage du contest
        function startContest() {
            state.duration = parseInt(document.getElementById('contestDuration').value) || 30;
            state.timerSeconds = state.duration * 60;
            state.timerRunning = true;
            
            // Afficher l'√©cran du contest
            showScreen('contestScreen');
            
            // Afficher et d√©marrer le timer
            document.getElementById('timerContainer').style.display = 'flex';
            document.getElementById('endContestBtn').style.display = 'block';
            updateTimerDisplay();
            startTimerInterval();
            
            // G√©n√©rer les boutons des √©l√®ves
            const studentsButtons = document.getElementById('studentsButtons');
            studentsButtons.innerHTML = state.students.map(s => `
                <button class="student-btn" onclick="selectStudent(${s.id})">${s.name}</button>
            `).join('');
            
            saveState();
        }

        // Timer
        function startTimerInterval() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                if (state.timerRunning && state.timerSeconds > 0) {
                    state.timerSeconds--;
                    updateTimerDisplay();
                    saveState();
                }
                
                if (state.timerSeconds === 0) {
                    state.timerRunning = false;
                    clearInterval(state.timerInterval);
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timerSeconds / 60);
            const seconds = state.timerSeconds % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = display;
            
            const container = document.getElementById('timerContainer');
            const message = document.getElementById('timerMessage');
            
            if (state.timerSeconds === 0) {
                container.className = 'timer-container danger';
                message.textContent = 'TEMPS √âCOUL√â';
            } else if (state.timerSeconds <= 60) {
                container.className = 'timer-container warning';
                message.textContent = '';
            } else {
                container.className = 'timer-container';
                message.textContent = '';
            }
        }

        function toggleTimer() {
            state.timerRunning = !state.timerRunning;
            const icon = document.getElementById('timerToggleIcon');
            icon.textContent = state.timerRunning ? '‚è∏' : '‚ñ∂';
            
            if (state.timerRunning) {
                startTimerInterval();
            }
            
            saveState();
        }

        function resetTimer() {
            if (confirm('R√©initialiser le chronom√®tre ?')) {
                state.timerSeconds = state.duration * 60;
                state.timerRunning = true;
                updateTimerDisplay();
                startTimerInterval();
                saveState();
            }
        }

        // S√©lection d'un √©l√®ve
        function selectStudent(studentId) {
            state.currentStudentId = studentId;
            const student = state.students.find(s => s.id === studentId);
            
            document.getElementById('validationStudentName').textContent = student.name;
            updateValidationScreen();
            showScreen('validationScreen');
        }

        function updateValidationScreen() {
            const studentId = state.currentStudentId;
            const validatedBlocks = state.validations[studentId] || [];
            
            // Mise √† jour du score
            const score = calculateStudentScore(studentId);
            document.getElementById('validationScore').textContent = score;
            document.getElementById('validationBlocksCount').textContent = validatedBlocks.length;
            
            // Affichage des blocs
            const blocksValidation = document.getElementById('blocksValidation');
            blocksValidation.innerHTML = state.blocks.map(block => {
                const isValidated = validatedBlocks.includes(block.id);
                const points = calculateBlockPoints(block.id);
                const validationCount = Object.values(state.validations)
                    .filter(blocks => blocks.includes(block.id)).length;
                
                return `
                    <div class="block-card ${isValidated ? 'validated' : ''}" onclick="toggleBlockValidation(${block.id})">
                        <div class="block-name">${block.name}</div>
                        <div class="block-info">${validationCount} √©l√®ve${validationCount > 1 ? 's' : ''}</div>
                        <div class="block-points">${points} pts</div>
                    </div>
                `;
            }).join('');
        }

        function toggleBlockValidation(blockId) {
            const studentId = state.currentStudentId;
            const validatedBlocks = state.validations[studentId];
            
            const index = validatedBlocks.indexOf(blockId);
            if (index === -1) {
                validatedBlocks.push(blockId);
            } else {
                validatedBlocks.splice(index, 1);
            }
            
            saveState();
            
            // Retour imm√©diat √† l'√©cran de s√©lection des √©l√®ves
            showScreen('contestScreen');
        }

        function backToContest() {
            showScreen('contestScreen');
        }

        // Points par bloc
        function showBlockPoints() {
            updateBlockPointsScreen();
            showScreen('blockPointsScreen');
        }

        function updateBlockPointsScreen() {
            const blockPointsList = document.getElementById('blockPointsList');
            
            blockPointsList.innerHTML = state.blocks.map(block => {
                const points = calculateBlockPoints(block.id);
                const validationCount = Object.values(state.validations)
                    .filter(blocks => blocks.includes(block.id)).length;
                const percentage = state.students.length > 0 
                    ? Math.round((validationCount / state.students.length) * 100) 
                    : 0;
                
                return `
                    <div class="block-card" style="cursor: default;">
                        <div class="block-name">${block.name}</div>
                        <div class="block-info">${validationCount} / ${state.students.length} √©l√®ves (${percentage}%)</div>
                        <div class="block-points">${points} pts</div>
                    </div>
                `;
            }).join('');
        }

        function backToContestFromBlockPoints() {
            showScreen('contestScreen');
        }

        // Classement
        function showRanking() {
            updateRankingScreen();
            showScreen('rankingScreen');
        }

        function updateRankingScreen() {
            // Calcul du classement
            const ranking = state.students.map(student => {
                const score = calculateStudentScore(student.id);
                const blocksValidated = (state.validations[student.id] || []).length;
                return { ...student, score, blocksValidated };
            }).sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.blocksValidated - a.blocksValidated;
            });

            // Podium
            const podium = document.getElementById('podium');
            if (ranking.length >= 3) {
                podium.innerHTML = `
                    <div class="podium-place silver">
                        <div class="medal">ü•à</div>
                        <div class="podium-name">${ranking[1].name}</div>
                        <div class="podium-score">${ranking[1].score} pts</div>
                        <div class="podium-score">${ranking[1].blocksValidated} blocs</div>
                    </div>
                    <div class="podium-place gold">
                        <div class="medal">ü•á</div>
                        <div class="podium-name">${ranking[0].name}</div>
                        <div class="podium-score">${ranking[0].score} pts</div>
                        <div class="podium-score">${ranking[0].blocksValidated} blocs</div>
                    </div>
                    <div class="podium-place bronze">
                        <div class="medal">ü•â</div>
                        <div class="podium-name">${ranking[2].name}</div>
                        <div class="podium-score">${ranking[2].score} pts</div>
                        <div class="podium-score">${ranking[2].blocksValidated} blocs</div>
                    </div>
                `;
            } else {
                podium.innerHTML = '';
            }

            // Liste compl√®te
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = ranking.map((student, index) => `
                <div class="ranking-item">
                    <div class="ranking-position">#${index + 1}</div>
                    <div class="ranking-name">${student.name}</div>
                    <div class="ranking-stats">
                        <div class="ranking-score">${student.score} pts</div>
                        <div class="ranking-blocks">${student.blocksValidated} blocs valid√©s</div>
                    </div>
                </div>
            `).join('');
        }

        function backToContestFromRanking() {
            showScreen('contestScreen');
        }

        function endContest() {
            if (confirm('Voulez-vous terminer le contest et voir le classement final ?')) {
                state.timerRunning = false;
                if (state.timerInterval) clearInterval(state.timerInterval);
                showRanking();
            }
        }

        function finishContest() {
            if (confirm('Terminer le contest et revenir √† la configuration ?')) {
                state.timerRunning = false;
                if (state.timerInterval) clearInterval(state.timerInterval);
                document.getElementById('timerContainer').style.display = 'none';
                document.getElementById('endContestBtn').style.display = 'none';
                showScreen('configScreen');
                saveState();
            }
        }

        // Export Excel
        function exportToExcel() {
            // Calcul du classement
            const ranking = state.students.map(student => {
                const score = calculateStudentScore(student.id);
                const blocksValidated = state.validations[student.id] || [];
                const blocksNames = blocksValidated.map(blockId => {
                    const block = state.blocks.find(b => b.id === blockId);
                    return block ? block.name : '';
                }).join(', ');
                
                return {
                    position: 0,
                    name: student.name,
                    score: score,
                    blocksCount: blocksValidated.length,
                    blocksNames: blocksNames
                };
            }).sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.blocksCount - a.blocksCount;
            }).map((student, index) => {
                student.position = index + 1;
                return student;
            });

            // Cr√©ation du fichier Excel
            const ws_data = [
                ['Position', 'Nom', 'Score', 'Blocs valid√©s', 'D√©tail des blocs'],
                ...ranking.map(r => [r.position, r.name, r.score, r.blocksCount, r.blocksNames])
            ];

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Classement');

            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Contest_Bloc_${date}.xlsx`);
        }

        // Export PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Calcul du classement
            const ranking = state.students.map(student => {
                const score = calculateStudentScore(student.id);
                const blocksValidated = state.validations[student.id] || [];
                const blocksNames = blocksValidated.map(blockId => {
                    const block = state.blocks.find(b => b.id === blockId);
                    return block ? block.name : '';
                }).join(', ');
                
                return {
                    position: 0,
                    name: student.name,
                    score: score,
                    blocksCount: blocksValidated.length,
                    blocksNames: blocksNames
                };
            }).sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.blocksCount - a.blocksCount;
            }).map((student, index) => {
                student.position = index + 1;
                return student;
            });

            // Titre
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Contest Bloc d\'Escalade', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const date = new Date().toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            doc.text(`Date: ${date}`, 105, 28, { align: 'center' });
            
            // Podium (Top 3)
            if (ranking.length >= 3) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Podium', 20, 40);
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Or
                doc.setTextColor(218, 165, 32); // Gold
                doc.text(`ü•á 1. ${ranking[0].name}`, 20, 50);
                doc.setTextColor(0, 0, 0);
                doc.text(`${ranking[0].score} pts - ${ranking[0].blocksCount} blocs`, 30, 56);
                
                // Argent
                doc.setTextColor(192, 192, 192); // Silver
                doc.text(`ü•à 2. ${ranking[1].name}`, 20, 66);
                doc.setTextColor(0, 0, 0);
                doc.text(`${ranking[1].score} pts - ${ranking[1].blocksCount} blocs`, 30, 72);
                
                // Bronze
                doc.setTextColor(205, 127, 50); // Bronze
                doc.text(`ü•â 3. ${ranking[2].name}`, 20, 82);
                doc.setTextColor(0, 0, 0);
                doc.text(`${ranking[2].score} pts - ${ranking[2].blocksCount} blocs`, 30, 88);
            }
            
            // Classement complet
            let yPos = ranking.length >= 3 ? 100 : 40;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Classement complet', 20, yPos);
            
            yPos += 10;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Pos', 20, yPos);
            doc.text('Nom', 35, yPos);
            doc.text('Score', 100, yPos);
            doc.text('Blocs', 125, yPos);
            doc.text('D√©tail des blocs', 150, yPos);
            
            yPos += 2;
            doc.line(20, yPos, 190, yPos);
            
            yPos += 6;
            doc.setFont(undefined, 'normal');
            
            ranking.forEach((student, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.text(`${student.position}`, 20, yPos);
                doc.text(student.name, 35, yPos);
                doc.text(`${student.score}`, 100, yPos);
                doc.text(`${student.blocksCount}`, 125, yPos);
                
                // D√©tail des blocs (tronqu√© si trop long)
                const detail = student.blocksNames.length > 30 
                    ? student.blocksNames.substring(0, 30) + '...' 
                    : student.blocksNames;
                doc.text(detail, 150, yPos);
                
                yPos += 8;
            });
            
            // Points par bloc (nouvelle page)
            doc.addPage();
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Valeur des blocs', 20, 20);
            
            yPos = 35;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Bloc', 20, yPos);
            doc.text('Validations', 100, yPos);
            doc.text('Points', 150, yPos);
            
            yPos += 2;
            doc.line(20, yPos, 190, yPos);
            
            yPos += 8;
            doc.setFont(undefined, 'normal');
            
            // Trier les blocs par points d√©croissants
            const blocksWithPoints = state.blocks.map(block => {
                const points = calculateBlockPoints(block.id);
                const validationCount = Object.values(state.validations)
                    .filter(blocks => blocks.includes(block.id)).length;
                return {
                    name: block.name,
                    validations: validationCount,
                    points: points
                };
            }).sort((a, b) => b.points - a.points);
            
            blocksWithPoints.forEach(block => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.text(block.name, 20, yPos);
                doc.text(`${block.validations} / ${state.students.length}`, 100, yPos);
                doc.text(`${block.points} pts`, 150, yPos);
                
                yPos += 8;
            });
            
            // Sauvegarde
            const dateFilename = new Date().toISOString().split('T')[0];
            doc.save(`Contest_Bloc_${dateFilename}.pdf`);
        }

        // R√©initialisation
        function resetAll() {
            if (confirm('Voulez-vous vraiment tout r√©initialiser ? Cette action est irr√©versible.')) {
                localStorage.removeItem('contestBlocState');
                state = {
                    students: [],
                    blocks: [],
                    validations: {},
                    duration: 30,
                    timerSeconds: 0,
                    timerRunning: false,
                    timerInterval: null,
                    currentStudentId: null,
                    nextStudentId: 1,
                    nextBlockId: 1
                };
                document.getElementById('contestDuration').value = 30;
                document.getElementById('timerContainer').style.display = 'none';
                if (state.timerInterval) clearInterval(state.timerInterval);
                showScreen('configScreen');
                updateUI();
            }
        }
    </script>
</body>
</html>