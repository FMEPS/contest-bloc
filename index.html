<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contest de Bloc - EPS Escalade</title>
    
    <!-- PWA Meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Contest Bloc">
    <meta name="theme-color" content="#0891b2">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAAB3CAYAAADb5cTzAAAYe2lDQ1BJQ0MgUHJvZmlsZQAAWIWVeQVYVUvX/+y9T9Pd3Sjd3Z3SqRy649CtiCghINKohFiIYBJKo4KIigGigqKIinUJQUWUbxN673vf//P/nm+eZ/b8zpo1a61Za2KvswHgmiBHRobC9ACEhcdQ7Ez0+V1c3fjxswABuAAn2Sc6Us/W1hKg5Xf7n2V5DEDr7UOpdVn/3f//LYy+ftE+AEAeKPb2jfYJQ3EPAJgjPpGUGABw63Sh+JjIdbwbxcwU1EAUF6/jgE18eh17b+KODR4HOwMUjwBAoCeTKQEA0E6hdP44nwBUDu0q2scY7hsUDgALOnOctk8g2RcALluUZ3tYWMQ6TkGxOMofieJ6FKt6/0NmwH/I9/4jn0wO+IM357VRCIZB0ZGh5MT/o2v+9xIWGvtbhyhaqQMppnbr80d9OB4SYbGOqVH8Mdzb2mrd1yj+FuS76XcAYFJgrKnjJj/M7RNtgPoPsKJY1pdsaIFibhQbh4daW27Rvf2DjM1QjPoMTgiKMXNAMTuKD/hFG9lv8dRQIuy2dMEt/hQDvS36IJmyoXdd1/PYEEe9LfkLgX5mW/IR2qRAB2cUk1AsHBfkZI1iWhRLR4fYW2zxaCYFGlj/5qHE2q3bL4xiO79wE/1N+UicP8XYbos/Jyz693yRmsAgM+stfDEm0MF80z/IdR/yhv3oXJARv3A9x99y/KJdLH/PxdfP0Ghz7sg7v3BH+y05373ySwV8Zv3zwpvQwq0CowDZpwB7rGCtHw0B2+d6yTczsN+YqcNxTDQTvNe8hL/gCQ=="/>
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAAB3CAYAAADb5cTzAAAYe2lDQ1BJQ0MgUHJvZmlsZQAAWIWVeQVYVUvX/+y9T9Pd3Sjd3Z3SqRy649CtiCghINKohFiIYBJKo4KIigGigqKIinUJQUWUbxN673vf//P/nm+eZ/b8zpo1a61Za2KvswHgmiBHRobC9ACEhcdQ7Ez0+V1c3fjxswABuAAn2Sc6Us/W1hKg5Xf7n2V5DEDr7UOpdVn/3f//LYy+ftE+AEAeKPb2jfYJQ3EPAJgjPpGUGABw63Sh+JjIdbwbxcwU1EAUF6/jgE18eh17b+KODR4HOwMUjwBAoCeTKQEA0E6hdP44nwBUDu0q2scY7hsUDgALOnOctk8g2RcALluUZ3tYWMQ6TkGxOMofieJ6FKt6/0NmwH/I9/4jn0wO+IM357VRCIZB0ZGh5MT/o2v+9xIWGvtbhyhaqQMppnbr80d9OB4SYbGOqVH8Mdzb2mrd1yj+FuS76XcAYFJgrKnjJj/M7RNtgPoPsKJY1pdsaIFibhQbh4daW27Rvf2DjM1QjPoMTgiKMXNAMTuKD/hFG9lv8dRQIuy2dMEt/hQDvS36IJmyoXdd1/PYEEe9LfkLgX5mW/IR2qRAB2cUk1AsHBfkZI1iWhRLR4fYW2zxaCYFGlj/5qHE2q3bL4xiO79wE/1N+UicP8XYbos/Jyz693yRmsAgM+stfDEm0MF80z/IdR/yhv3oXJARv3A9x99y/KJdLH/PxdfP0Ghz7sg7v3BH+y05373ySwV8Zv3zwpvQwq0CowDZpwB7rGCtHw0B2+d6yTczsN+YqcNxTDQTvNe8hL/gCQ=="/>
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAAB3CAYAAADb5cTzAAAYe2lDQ1BJQ0MgUHJvZmlsZQAAWIWVeQVYVUvX/+y9T9Pd3Sjd3Z3SqRy649CtiCghINKohFiIYBJKo4KIigGigqKIinUJQUWUbxN673vf//P/nm+eZ/b8zpo1a61Za2KvswHgmiBHRobC9ACEhcdQ7Ez0+V1c3fjxswABuAAn2Sc6Us/W1hKg5Xf7n2V5DEDr7UOpdVn/3f//LYy+ftE+AEAeKPb2jfYJQ3EPAJgjPpGUGABw63Sh+JjIdbwbxcwU1EAUF6/jgE18eh17b+KODR4HOwMUjwBAoCeTKQEA0E6hdP44nwBUDu0q2scY7hsUDgALOnOctk8g2RcALluUZ3tYWMQ6TkGxOMofieJ6FKt6/0NmwH/I9/4jn0wO+IM357VRCIZB0ZGh5MT/o2v+9xIWGvtbhyhaqQMppnbr80d9OB4SYbGOqVH8Mdzb2mrd1yj+FuS76XcAYFJgrKnjJj/M7RNtgPoPsKJY1pdsaIFibhQbh4daW27Rvf2DjM1QjPoMTgiKMXNAMTuKD/hFG9lv8dRQIuy2dMEt/hQDvS36IJmyoXdd1/PYEEe9LfkLgX5mW/IR2qRAB2cUk1AsHBfkZI1iWhRLR4fYW2zxaCYFGlj/5qHE2q3bL4xiO79wE/1N+UicP8XYbos/Jyz693yRmsAgM+stfDEm0MF80z/IdR/yhv3oXJARv3A9x99y/KJdLH/PxdfP0Ghz7sg7v3BH+y05373ySwV8Zv3zwpvQwq0CowDZpwB7rGCtHw0B2+d6yTczsN+YqcNxTDQTvNe8hL/gCQ=="/>
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAAB3CAYAAADb5cTzAAAYe2lDQ1BJQ0MgUHJvZmlsZQAAWIWVeQVYVUvX/+y9T9Pd3Sjd3Z3SqRy649CtiCghINKohFiIYBJKo4KIigGigqKIinUJQUWUbxN673vf//P/nm+eZ/b8zpo1a61Za2KvswHgmiBHRobC9ACEhcdQ7Ez0+V1c3fjxswABuAAn2Sc6Us/W1hKg5Xf7n2V5DEDr7UOpdVn/3f//LYy+ftE+AEAeKPb2jfYJQ3EPAJgjPpGUGABw63Sh+JjIdbwbxcwU1EAUF6/jgE18eh17b+KODR4HOwMUjwBAoCeTKQEA0E6hdP44nwBUDu0q2scY7hsUDgALOnOctk8g2RcALluUZ3tYWMQ6TkGxOMofieJ6FKt6/0NmwH/I9/4jn0wO+IM357VRCIZB0ZGh5MT/o2v+9xIWGvtbhyhaqQMppnbr80d9OB4SYbGOqVH8Mdzb2mrd1yj+FuS76XcAYFJgrKnjJj/M7RNtgPoPsKJY1pdsaIFibhQbh4daW27Rvf2DjM1QjPoMTgiKMXNAMTuKD/hFG9lv8dRQIuy2dMEt/hQDvS36IJmyoXdd1/PYEEe9LfkLgX5mW/IR2qRAB2cUk1AsHBfkZI1iWhRLR4fYW2zxaCYFGlj/5qHE2q3bL4xiO79wE/1N+UicP8XYbos/Jyz693yRmsAgM+stfDEm0MF80z/IdR/yhv3oXJARv3A9x99y/KJdLH/PxdfP0Ghz7sg7v3BH+y05373ySwV8Zv3zwpvQwq0CowDZpwB7rGCtHw0B2+d6yTczsN+YqcNxTDQTvNe8hL/gCQ==">
    
    <!-- Manifest -->
    <link rel="manifest" id="manifest-placeholder">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 120px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #4f46e5;
            margin-bottom: 20px;
            font-size: 2em;
        }

        h2 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:disabled {
            background: #9ca3af !important;
            cursor: not-allowed;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 12px 24px;
            background: #8b5cf6;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            background: #7c3aed;
        }

        input[type="text"],
        input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .section {
            margin-bottom: 30px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        .student-item {
            background: #dbeafe;
        }

        .block-item {
            background: #d1fae5;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
        }

        .delete-btn:hover {
            color: #dc2626;
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .student-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .student-btn {
            padding: 20px;
            background: #4f46e5;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        .student-btn:hover {
            background: #4338ca;
        }

        .ranking {
            max-height: 500px;
            overflow-y: auto;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f9fafb;
        }

        .rank-item.gold {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .rank-item.silver {
            background: #f3f4f6;
            border: 2px solid #9ca3af;
        }

        .rank-item.bronze {
            background: #fed7aa;
            border: 2px solid #f97316;
        }

        .rank-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rank-number {
            font-size: 24px;
            font-weight: bold;
            color: #374151;
            min-width: 40px;
        }

        .rank-name {
            font-size: 18px;
            font-weight: 600;
        }

        .rank-right {
            text-align: right;
        }

        .rank-score {
            font-size: 24px;
            font-weight: bold;
            color: #4f46e5;
        }

        .rank-blocks {
            font-size: 14px;
            color: #6b7280;
        }

        .blocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .block-btn {
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .block-btn:hover {
            border-color: #4f46e5;
        }

        .block-btn.validated {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .block-btn.validated:hover {
            background: #059669;
        }

        .block-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .block-points {
            font-size: 16px;
        }

        .block-stats {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .timer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #4f46e5;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .timer.warning {
            background: #f97316;
        }

        .timer.finished {
            background: #ef4444;
        }

        .timer-label {
            font-size: 14px;
            margin-right: 10px;
        }

        .timer-display {
            font-size: 32px;
            font-weight: bold;
            margin: 0 20px;
        }

        .timer-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .timer-btn {
            padding: 6px 12px;
            background: white;
            color: #4f46e5;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .timer-btn:hover {
            background: #f3f4f6;
        }

        .duration-input {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .duration-input input {
            width: 100px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .info-text {
            color: #6b7280;
            font-size: 14px;
            margin-top: 8px;
        }

        .student-score-display {
            background: #dbeafe;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .student-score-display .score {
            font-size: 32px;
            font-weight: bold;
            color: #4f46e5;
        }

        .student-score-display .blocks {
            color: #6b7280;
            margin-top: 5px;
        }

        .final-results {
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }

        .final-header {
            margin-bottom: 40px;
        }

        .final-header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .export-btn {
            margin: 30px 0;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 40px 0;
        }

        .podium-place {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            min-width: 150px;
        }

        .podium-first {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            padding-top: 40px;
        }

        .podium-second {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 3px solid #9ca3af;
            padding-top: 30px;
        }

        .podium-third {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            border: 3px solid #f97316;
            padding-top: 30px;
        }

        .podium-rank {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .podium-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .podium-score {
            font-size: 32px;
            font-weight: bold;
            color: #4f46e5;
        }

        .end-contest-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="configPage" class="container">
        <div class="header">
            <h1>Configuration du Contest</h1>
            <button class="btn-danger" onclick="resetAll()">R√©initialiser</button>
        </div>

        <div class="section">
            <h2>√âl√®ves (<span id="studentCount">0</span>/50)</h2>
            <div class="input-group">
                <input type="text" id="studentInput" placeholder="Pr√©nom de l'√©l√®ve" maxlength="30">
                <button class="btn-primary" onclick="addStudent()">Ajouter</button>
                <div class="file-input-wrapper">
                    <input type="file" id="csvFileInput" accept=".csv" onchange="importStudentsFromCSV(event)">
                    <label for="csvFileInput" class="file-input-label">üìÑ Importer CSV</label>
                </div>
            </div>
            <div id="studentsList" class="items-grid"></div>
        </div>

        <div class="section">
            <h2>Blocs (<span id="blockCount">0</span>/30)</h2>
            <div class="input-group">
                <input type="text" id="blockInput" placeholder="Nom du bloc" maxlength="30">
                <button class="btn-success" onclick="addBlock()">Ajouter</button>
                <div class="file-input-wrapper">
                    <input type="file" id="csvBlockFileInput" accept=".csv" onchange="importBlocksFromCSV(event)">
                    <label for="csvBlockFileInput" class="file-input-label">üìÑ Importer CSV</label>
                </div>
            </div>
            <div id="blocksList" class="items-grid"></div>
        </div>

        <div class="section">
            <h2>Dur√©e du contest</h2>
            <div class="duration-input">
                <input type="number" id="durationInput" value="30" min="1" max="120">
                <span>minutes</span>
            </div>
            <p class="info-text">Dur√©e entre 1 et 120 minutes</p>
        </div>

        <button id="startBtn" class="btn-primary" style="width: 100%; padding: 15px; font-size: 18px;" onclick="startContest()" disabled>
            D√©marrer le Contest
        </button>
        <p id="startWarning" class="info-text" style="color: #ef4444; text-align: center; margin-top: 10px;">
            Ajoutez au moins un √©l√®ve et un bloc pour continuer
        </p>
    </div>

    <div id="mainPage" class="container hidden">
        <div class="header">
            <h1>Contest de Bloc</h1>
            <div>
                <button class="btn-secondary" onclick="showConfig()">Configuration</button>
                <button class="btn-warning end-contest-btn" onclick="endContest()">üèÅ Fin du Contest</button>
            </div>
        </div>

        <div class="two-columns">
            <div>
                <h2>S√©lectionner un √©l√®ve</h2>
                <div id="studentButtons" class="student-buttons"></div>
            </div>

            <div>
                <h2>Classement</h2>
                <div id="ranking" class="ranking"></div>
            </div>
        </div>
    </div>

    <div id="validationPage" class="container hidden">
        <div class="header">
            <h1 id="studentName"></h1>
            <button class="btn-secondary" onclick="backToMain()">Retour</button>
        </div>

        <div id="studentScoreDisplay" class="student-score-display"></div>

        <h2>Valider un bloc</h2>
        <div id="blocksGrid" class="blocks-grid"></div>
    </div>

    <div id="finalPage" class="container hidden">
        <div class="final-results">
            <div class="final-header">
                <h1>üèÜ R√©sultats Finaux üèÜ</h1>
                <p style="font-size: 18px; color: #6b7280;">Contest termin√© !</p>
            </div>

            <div id="podiumDisplay" class="podium"></div>

            <button class="btn-success export-btn" onclick="exportResultsToXLS()" style="font-size: 18px; padding: 15px 30px;">
                üì• Exporter les r√©sultats (Excel)
            </button>

            <h2 style="margin-top: 40px; margin-bottom: 20px;">Classement complet</h2>
            <div id="finalRanking" class="ranking"></div>

            <button class="btn-secondary" onclick="backToConfig()" style="margin-top: 30px; font-size: 16px;">
                ‚öôÔ∏è Retour √† la configuration
            </button>
        </div>
    </div>

    <div id="timer" class="timer hidden">
        <div class="timer-label">Temps restant</div>
        <div id="timerDisplay" class="timer-display">0:00</div>
        <div class="timer-controls">
            <button id="pauseBtn" class="timer-btn" onclick="pauseTimer()">Pause</button>
            <button id="resumeBtn" class="timer-btn hidden" onclick="resumeTimer()">Reprendre</button>
            <button class="timer-btn" onclick="resetTimer()">Reset</button>
        </div>
    </div>

    <script>
        var students = [];
        var blocks = [];
        var validations = {};
        var currentStudent = null;
        var timerInterval = null;
        var timeRemaining = null;
        var isTimerRunning = false;
        var contestDuration = 30;
        var contestInProgress = false;

        window.onload = function() {
            loadData();
            updateUI();
            
            // Cr√©er le manifest dynamiquement
            var manifestData = {
                "name": "Contest de Bloc",
                "short_name": "Contest Bloc",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#0891b2",
                "theme_color": "#0891b2",
                "icons": [
                    {
                        "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+0lEQVR4nO3WMQ0AIBAEsYP+O7MA8iMEswGZL8xs8L3PAzARgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApA7nRMO5A0SHEcAAAAASUVORK5CYII=",
                        "sizes": "192x192",
                        "type": "image/png"
                    },
                    {
                        "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+0lEQVR4nO3WMQ0AIBAEsYP+O7MA8iMEswGZL8xs8L3PAzARgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApATgJwA5AQgJwA5AcgJQE4AcgKQE4CcAOQEICcAOQHICUBOAHICkBOAnADkBCAnADkByAlATgByApA7nRMO5A0SHEcAAAAASUVORK5CYII=",
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            };
            
            var manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
            var manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

            document.getElementById('studentInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addStudent();
                }
            });
            document.getElementById('blockInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addBlock();
                }
            });
        };

        window.onbeforeunload = function(e) {
            if (contestInProgress) {
                e.preventDefault();
                e.returnValue = 'Un contest est en cours. √ätes-vous s√ªr de vouloir quitter ?';
                return e.returnValue;
            }
        };

        function saveData() {
            localStorage.setItem('contest-students', JSON.stringify(students));
            localStorage.setItem('contest-blocks', JSON.stringify(blocks));
            localStorage.setItem('contest-validations', JSON.stringify(validations));
            localStorage.setItem('contest-duration', contestDuration);
        }

        function loadData() {
            var savedStudents = localStorage.getItem('contest-students');
            var savedBlocks = localStorage.getItem('contest-blocks');
            var savedValidations = localStorage.getItem('contest-validations');
            var savedDuration = localStorage.getItem('contest-duration');

            if (savedStudents) {
                students = JSON.parse(savedStudents);
            }
            if (savedBlocks) {
                blocks = JSON.parse(savedBlocks);
            }
            if (savedValidations) {
                validations = JSON.parse(savedValidations);
            }
            if (savedDuration) {
                contestDuration = parseInt(savedDuration);
                document.getElementById('durationInput').value = contestDuration;
            }
        }

        function addStudent() {
            var input = document.getElementById('studentInput');
            var name = input.value.trim();
            
            if (name && students.length < 50) {
                students.push({ id: Date.now(), name: name });
                input.value = '';
                saveData();
                updateUI();
            }
        }

        function importStudentsFromCSV(event) {
            var file = event.target.files[0];
            if (!file) {
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                var lines = text.split('\n');
                var importedCount = 0;

                for (var i = 0; i < lines.length; i++) {
                    if (students.length >= 50) {
                        break;
                    }

                    var line = lines[i].trim();
                    if (line) {
                        var columns = line.split(',');
                        var name = columns[0].trim();
                        
                        name = name.replace(/^["']|["']$/g, '');
                        
                        if (name && name.length > 0) {
                            var isDuplicate = false;
                            for (var j = 0; j < students.length; j++) {
                                if (students[j].name.toLowerCase() === name.toLowerCase()) {
                                    isDuplicate = true;
                                    break;
                                }
                            }
                            
                            if (!isDuplicate) {
                                students.push({ id: Date.now() + i, name: name });
                                importedCount++;
                            }
                        }
                    }
                }

                saveData();
                updateUI();
                
                event.target.value = '';
                
                if (importedCount > 0) {
                    alert(importedCount + ' √©l√®ve(s) import√©(s) avec succ√®s !');
                } else {
                    alert('Aucun nouvel √©l√®ve √† importer.');
                }
            };

            reader.onerror = function() {
                alert('Erreur lors de la lecture du fichier CSV.');
            };

            reader.readAsText(file);
        }

        function removeStudent(id) {
            var newStudents = [];
            for (var i = 0; i < students.length; i++) {
                if (students[i].id !== id) {
                    newStudents.push(students[i]);
                }
            }
            students = newStudents;
            delete validations[id];
            saveData();
            updateUI();
        }

        function addBlock() {
            var input = document.getElementById('blockInput');
            var name = input.value.trim();
            
            if (name && blocks.length < 30) {
                blocks.push({ id: Date.now(), name: name });
                input.value = '';
                saveData();
                updateUI();
            }
        }

        function importBlocksFromCSV(event) {
            var file = event.target.files[0];
            if (!file) {
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                var lines = text.split('\n');
                var importedCount = 0;

                for (var i = 0; i < lines.length; i++) {
                    if (blocks.length >= 30) {
                        break;
                    }

                    var line = lines[i].trim();
                    if (line) {
                        var columns = line.split(',');
                        var name = columns[0].trim();
                        
                        name = name.replace(/^["']|["']$/g, '');
                        
                        if (name && name.length > 0) {
                            var isDuplicate = false;
                            for (var j = 0; j < blocks.length; j++) {
                                if (blocks[j].name.toLowerCase() === name.toLowerCase()) {
                                    isDuplicate = true;
                                    break;
                                }
                            }
                            
                            if (!isDuplicate) {
                                blocks.push({ id: Date.now() + i, name: name });
                                importedCount++;
                            }
                        }
                    }
                }

                saveData();
                updateUI();
                
                event.target.value = '';
                
                if (importedCount > 0) {
                    alert(importedCount + ' bloc(s) import√©(s) avec succ√®s !');
                } else {
                    alert('Aucun nouveau bloc √† importer.');
                }
            };

            reader.onerror = function() {
                alert('Erreur lors de la lecture du fichier CSV.');
            };

            reader.readAsText(file);
        }

        function removeBlock(id) {
            var newBlocks = [];
            for (var i = 0; i < blocks.length; i++) {
                if (blocks[i].id !== id) {
                    newBlocks.push(blocks[i]);
                }
            }
            blocks = newBlocks;
            
            for (var studentId in validations) {
                var newValidations = [];
                for (var j = 0; j < validations[studentId].length; j++) {
                    if (validations[studentId][j] !== id) {
                        newValidations.push(validations[studentId][j]);
                    }
                }
                validations[studentId] = newValidations;
            }
            saveData();
            updateUI();
        }

        function calculateBlockValue(blockId) {
            if (students.length === 0) {
                return 100;
            }
            
            var validationCount = 0;
            for (var key in validations) {
                if (validations[key] && validations[key].indexOf(blockId) !== -1) {
                    validationCount++;
                }
            }
            
            var percentage = (validationCount / students.length) * 100;
            var points = Math.round(100 - percentage);
            
            if (points === 0) {
                return 5;
            }
            return points;
        }

        function calculateStudentScore(studentId) {
            var studentValidations = validations[studentId] || [];
            var total = 0;
            for (var i = 0; i < studentValidations.length; i++) {
                total = total + calculateBlockValue(studentValidations[i]);
            }
            return total;
        }

        function getRanking() {
            var ranking = [];
            for (var i = 0; i < students.length; i++) {
                var student = students[i];
                ranking.push({
                    id: student.id,
                    name: student.name,
                    score: calculateStudentScore(student.id),
                    validatedBlocks: (validations[student.id] || []).length
                });
            }
            
            ranking.sort(function(a, b) {
                return b.score - a.score;
            });
            
            return ranking;
        }

        function startContest() {
            contestDuration = parseInt(document.getElementById('durationInput').value);
            timeRemaining = contestDuration * 60;
            isTimerRunning = true;
            contestInProgress = true;
            saveData();
            showMain();
            startTimerInterval();
        }

        function showConfig() {
            document.getElementById('configPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('validationPage').classList.add('hidden');
            document.getElementById('finalPage').classList.add('hidden');
        }

        function showMain() {
            document.getElementById('configPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('validationPage').classList.add('hidden');
            document.getElementById('finalPage').classList.add('hidden');
            document.getElementById('timer').classList.remove('hidden');
            updateRanking();
            updateStudentButtons();
        }

        function showValidation(studentId) {
            currentStudent = studentId;
            var student = null;
            for (var i = 0; i < students.length; i++) {
                if (students[i].id === studentId) {
                    student = students[i];
                    break;
                }
            }
            
            document.getElementById('configPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('validationPage').classList.remove('hidden');
            document.getElementById('finalPage').classList.add('hidden');
            
            document.getElementById('studentName').textContent = student.name;
            updateValidationPage();
        }

        function showFinalResults() {
            document.getElementById('configPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('validationPage').classList.add('hidden');
            document.getElementById('finalPage').classList.remove('hidden');
            document.getElementById('timer').classList.add('hidden');
            
            displayFinalResults();
        }

        function backToConfig() {
            if (confirm('Voulez-vous vraiment revenir √† la configuration ? Cela r√©initialisera le chronom√®tre.')) {
                timeRemaining = null;
                isTimerRunning = false;
                contestInProgress = false;
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                showConfig();
            }
        }

        function backToMain() {
            currentStudent = null;
            showMain();
        }

        function endContest() {
            var confirmFirst = confirm('√ätes-vous s√ªr de vouloir terminer le contest ?');
            if (!confirmFirst) {
                return;
            }
            
            var confirmSecond = confirm('Cette action est irr√©versible. Confirmer la fin du contest ?');
            if (!confirmSecond) {
                return;
            }
            
            isTimerRunning = false;
            contestInProgress = false;
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            showFinalResults();
        }

        function displayFinalResults() {
            var ranking = getRanking();
            
            var podiumHTML = '';
            if (ranking.length >= 2) {
                podiumHTML += '<div class="podium-place podium-second">';
                podiumHTML += '<div class="podium-rank">ü•à</div>';
                podiumHTML += '<div class="podium-name">' + ranking[1].name + '</div>';
                podiumHTML += '<div class="podium-score">' + ranking[1].score + ' pts</div>';
                podiumHTML += '<div class="rank-blocks">' + ranking[1].validatedBlocks + ' blocs</div>';
                podiumHTML += '</div>';
            }
            
            if (ranking.length >= 1) {
                podiumHTML += '<div class="podium-place podium-first">';
                podiumHTML += '<div class="podium-rank">ü•á</div>';
                podiumHTML += '<div class="podium-name">' + ranking[0].name + '</div>';
                podiumHTML += '<div class="podium-score">' + ranking[0].score + ' pts</div>';
                podiumHTML += '<div class="rank-blocks">' + ranking[0].validatedBlocks + ' blocs</div>';
                podiumHTML += '</div>';
            }
            
            if (ranking.length >= 3) {
                podiumHTML += '<div class="podium-place podium-third">';
                podiumHTML += '<div class="podium-rank">ü•â</div>';
                podiumHTML += '<div class="podium-name">' + ranking[2].name + '</div>';
                podiumHTML += '<div class="podium-score">' + ranking[2].score + ' pts</div>';
                podiumHTML += '<div class="rank-blocks">' + ranking[2].validatedBlocks + ' blocs</div>';
                podiumHTML += '</div>';
            }
            
            document.getElementById('podiumDisplay').innerHTML = podiumHTML;
            
            var rankingHTML = '';
            for (var i = 0; i < ranking.length; i++) {
                var student = ranking[i];
                var rankClass = '';
                if (i === 0) {
                    rankClass = 'gold';
                } else if (i === 1) {
                    rankClass = 'silver';
                } else if (i === 2) {
                    rankClass = 'bronze';
                }
                
                rankingHTML += '<div class="rank-item ' + rankClass + '">';
                rankingHTML += '<div class="rank-left">';
                rankingHTML += '<div class="rank-number">' + (i + 1) + '.</div>';
                rankingHTML += '<div class="rank-name">' + student.name + '</div>';
                rankingHTML += '</div>';
                rankingHTML += '<div class="rank-right">';
                rankingHTML += '<div class="rank-score">' + student.score + ' pts</div>';
                rankingHTML += '<div class="rank-blocks">' + student.validatedBlocks + ' blocs</div>';
                rankingHTML += '</div>';
                rankingHTML += '</div>';
            }
            document.getElementById('finalRanking').innerHTML = rankingHTML;
        }

        function exportResultsToXLS() {
            var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">';
            html += '<head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Resultats Contest</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>';
            html += '<body><table border="1">';
            
            html += '<thead><tr style="background-color: #4f46e5; color: white; font-weight: bold;">';
            html += '<th>Pr√©nom</th>';
            
            for (var i = 0; i < blocks.length; i++) {
                html += '<th>' + blocks[i].name + '</th>';
            }
            html += '<th>Score Total</th>';
            html += '<th>Blocs Valid√©s</th>';
            html += '</tr></thead><tbody>';
            
            var ranking = getRanking();
            for (var j = 0; j < ranking.length; j++) {
                var student = ranking[j];
                var rowColor = '';
                if (j === 0) rowColor = ' style="background-color: #fef3c7;"';
                else if (j === 1) rowColor = ' style="background-color: #f3f4f6;"';
                else if (j === 2) rowColor = ' style="background-color: #fed7aa;"';
                
                html += '<tr' + rowColor + '>';
                html += '<td><strong>' + student.name + '</strong></td>';
                
                var studentValidations = validations[student.id] || [];
                for (var k = 0; k < blocks.length; k++) {
                    var hasValidated = studentValidations.indexOf(blocks[k].id) !== -1;
                    html += '<td style="text-align: center;">' + (hasValidated ? 'OUI' : '') + '</td>';
                }
                
                html += '<td style="text-align: center;"><strong>' + student.score + '</strong></td>';
                html += '<td style="text-align: center;">' + student.validatedBlocks + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table></body></html>';
            
            var blob = new Blob([html], {
                type: 'application/vnd.ms-excel'
            });
            
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'resultats_contest_bloc.xls');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleValidation(blockId) {
            if (!validations[currentStudent]) {
                validations[currentStudent] = [];
            }
            
            var index = validations[currentStudent].indexOf(blockId);
            if (index > -1) {
                validations[currentStudent].splice(index, 1);
            } else {
                validations[currentStudent].push(blockId);
            }
            
            saveData();
            backToMain();
        }

        function startTimerInterval() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(function() {
                if (isTimerRunning && timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining === 0) {
                        isTimerRunning = false;
                        clearInterval(timerInterval);
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerRunning = false;
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('resumeBtn').classList.remove('hidden');
        }

        function resumeTimer() {
            if (timeRemaining > 0) {
                isTimerRunning = true;
                document.getElementById('pauseBtn').classList.remove('hidden');
                document.getElementById('resumeBtn').classList.add('hidden');
                startTimerInterval();
            }
        }

        function resetTimer() {
            timeRemaining = contestDuration * 60;
            isTimerRunning = false;
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('resumeBtn').classList.add('hidden');
            updateTimerDisplay();
        }

        function formatTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function updateTimerDisplay() {
            var timerEl = document.getElementById('timer');
            var displayEl = document.getElementById('timerDisplay');
            var labelEl = timerEl.querySelector('.timer-label');
            
            displayEl.textContent = formatTime(timeRemaining);
            
            timerEl.classList.remove('warning');
            timerEl.classList.remove('finished');
            
            if (timeRemaining === 0) {
                timerEl.classList.add('finished');
                labelEl.textContent = 'TEMPS √âCOUL√â';
            } else if (timeRemaining <= 60) {
                timerEl.classList.add('warning');
                labelEl.textContent = 'Temps restant';
            } else {
                labelEl.textContent = 'Temps restant';
            }
        }

        function updateUI() {
            document.getElementById('studentCount').textContent = students.length;
            document.getElementById('blockCount').textContent = blocks.length;
            
            var studentsList = document.getElementById('studentsList');
            var html = '';
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                html += '<div class="item student-item"><span>' + s.name + '</span><button class="delete-btn" onclick="removeStudent(' + s.id + ')">‚úï</button></div>';
            }
            studentsList.innerHTML = html;
            
            var blocksList = document.getElementById('blocksList');
            html = '';
            for (var j = 0; j < blocks.length; j++) {
                var b = blocks[j];
                html += '<div class="item block-item"><span>' + b.name + '</span><button class="delete-btn" onclick="removeBlock(' + b.id + ')">‚úï</button></div>';
            }
            blocksList.innerHTML = html;
            
            var canStart = students.length > 0 && blocks.length > 0;
            document.getElementById('startBtn').disabled = !canStart;
            document.getElementById('startWarning').style.display = canStart ? 'none' : 'block';
        }

        function updateStudentButtons() {
            var container = document.getElementById('studentButtons');
            var html = '';
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                html += '<button class="student-btn" onclick="showValidation(' + s.id + ')">' + s.name + '</button>';
            }
            container.innerHTML = html;
        }

        function updateRanking() {
            var ranking = getRanking();
            var container = document.getElementById('ranking');
            var html = '';
            
            for (var i = 0; i < ranking.length; i++) {
                var student = ranking[i];
                var rankClass = '';
                if (i === 0) {
                    rankClass = 'gold';
                } else if (i === 1) {
                    rankClass = 'silver';
                } else if (i === 2) {
                    rankClass = 'bronze';
                }
                
                html += '<div class="rank-item ' + rankClass + '">';
                html += '<div class="rank-left">';
                html += '<div class="rank-number">' + (i + 1) + '.</div>';
                html += '<div class="rank-name">' + student.name + '</div>';
                html += '</div>';
                html += '<div class="rank-right">';
                html += '<div class="rank-score">' + student.score + ' pts</div>';
                html += '<div class="rank-blocks">' + student.validatedBlocks + ' blocs</div>';
                html += '</div>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function updateValidationPage() {
            var studentValidations = validations[currentStudent] || [];
            var score = calculateStudentScore(currentStudent);
            
            document.getElementById('studentScoreDisplay').innerHTML = '<div class="score">' + score + ' points</div><div class="blocks">' + studentValidations.length + ' blocs valid√©s</div>';
            
            var container = document.getElementById('blocksGrid');
            var html = '';
            for (var i = 0; i < blocks.length; i++) {
                var block = blocks[i];
                var isValidated = studentValidations.indexOf(block.id) !== -1;
                var blockValue = calculateBlockValue(block.id);
                var validationCount = 0;
                for (var key in validations) {
                    if (validations[key] && validations[key].indexOf(block.id) !== -1) {
                        validationCount++;
                    }
                }
                
                html += '<button class="block-btn ' + (isValidated ? 'validated' : '') + '" onclick="toggleValidation(' + block.id + ')">';
                html += '<div class="block-name">' + block.name + '</div>';
                html += '<div class="block-points">' + blockValue + ' pts</div>';
                html += '<div class="block-stats">' + validationCount + '/' + students.length + ' √©l√®ves</div>';
                html += '</button>';
            }
            container.innerHTML = html;
        }

        function resetAll() {
            if (confirm('√ätes-vous s√ªr de vouloir tout r√©initialiser ?')) {
                students = [];
                blocks = [];
                validations = {};
                timeRemaining = null;
                isTimerRunning = false;
                contestInProgress = false;
                contestDuration = 30;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                
                localStorage.clear();
                
                document.getElementById('durationInput').value = 30;
                document.getElementById('timer').classList.add('hidden');
                
                showConfig();
                updateUI();
            }
        }
    </script>
</body>
</html>